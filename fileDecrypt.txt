BEWARE OF BUGS IN THE ABOVE CODE